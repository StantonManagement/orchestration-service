# Story 2.1: Payment Plan Detection

## Status
Approved

## Story
**As a** collections system,
**I want** to automatically detect payment plan offers in tenant messages,
**so that** payment arrangements can be processed efficiently without manual intervention.

## Acceptance Criteria
1. Payment plan extraction logic with pattern matching for weekly amounts and durations
2. POST `/orchestrate/payment-plan-detected` endpoint to process extracted payment plans
3. Payment plan validation against business rules (max 12 weeks, minimum $25/week)
4. Integration with AI response parsing to identify structured payment plans
5. Database storage of detected payment plans with validation results

## Tasks / Subtasks
- [ ] Task 1: Create payment plan extraction utility (AC: 1)
  - [ ] Create `app/utils/payment_plan_extraction.py` with PaymentPlanExtractor class
  - [ ] Implement pattern matching for weekly amounts ($XX, $XXX, etc.)
  - [ ] Implement duration extraction (weeks, months, for X weeks)
  - [ ] Add start date detection patterns (starting Monday, next week, etc.)
  - [ ] Create extract_payment_plan() method returning structured data
  - [ ] Add confidence scoring for extracted payment plans
- [ ] Task 2: Create payment plan validation service (AC: 3)
  - [ ] Create `app/services/payment_plan_service.py` with PaymentPlanValidator class
  - [ ] Implement business rule validation (max 12 weeks, min $25/week)
  - [ ] Add validation for realistic payment amounts based on tenant data
  - [ ] Create validate_payment_plan() method with detailed error reporting
  - [ ] Implement auto-approval logic for clearly valid plans
- [ ] Task 3: Create payment plan API endpoint (AC: 2)
  - [ ] Create `app/api/payment_plan.py` with payment plan router
  - [ ] Implement POST /orchestrate/payment-plan-detected endpoint
  - [ ] Create `app/schemas/payment_plan.py` with PaymentPlanDetected schema
  - [ ] Add request validation for conversation_id, tenant_id, message_content
  - [ ] Implement integration with extraction and validation services
  - [ ] Add proper error handling for invalid payment plans
- [ ] Task 4: Implement payment plan database operations (AC: 5)
  - [ ] Create `app/models/payment_plan.py` with PaymentPlanAttempt model
  - [ ] Implement create_payment_plan_attempt() database method
  - [ ] Add update_validation_results() method for validation status
  - [ ] Create get_payment_plans_by_conversation() method for retrieval
  - [ ] Implement audit logging for payment plan changes
- [ ] Task 5: Integrate with AI response parsing (AC: 4)
  - [ ] Update AI service to detect structured payment plan responses
  - [ ] Add parsing for AI responses with PAYMENT_PLAN markers
  - [ ] Integrate payment plan detection into main SMS workflow
  - [ ] Add workflow step tracking for payment plan detection
  - [ ] Update orchestration service to call payment plan endpoint
- [ ] Task 6: Create comprehensive tests (Test Strategy compliance)
  - [ ] Create `tests/test_utils/test_payment_plan_extraction.py` for extraction logic
  - [ ] Create `tests/test_services/test_payment_plan_service.py` for validation logic
  - [ ] Create `tests/test_api/test_payment_plan.py` for API endpoint tests
  - [ ] Test extraction patterns with various payment plan formats
  - [ ] Test validation business rules and edge cases
  - [ ] Test integration with AI response parsing

## Dev Notes

### Previous Story Insights
From Story 1.5 (Workflow Status Tracking):
- Workflow state machine infrastructure is in place for tracking payment plan processing
- Database schema supports payment plan attempts through the `payment_plan_attempts` table
- Structured logging with correlation IDs is implemented for audit trails
- API routing patterns are established for new endpoints

### Data Models
**PaymentPlanAttempt Model** (from `docs/architecture/data-models.md`):
- **Purpose**: Tracks extracted payment plans and validation results
- **Key Attributes**:
  - id: UUID - Primary key
  - workflow_id: UUID - Reference to parent workflow
  - extracted_from: String - Source (tenant_message or ai_response)
  - weekly_amount: Decimal - Proposed weekly payment
  - duration_weeks: Integer - Number of weeks
  - start_date: Date - Proposed start date
  - validation_result: JSON - Validation issues and auto-approvable status
  - status: String - Validation status (valid, invalid, needs_review)
  - created_at: Timestamp - When payment plan was detected
- **Relationships**: Belongs to WorkflowInstance
- **Validation**: Validated against business rules in PaymentPlanValidator service

**Database Schema** (from `docs/architecture/database-schema.md`):
```sql
CREATE TABLE payment_plan_attempts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    workflow_id uuid REFERENCES orchestration_workflows(id) ON DELETE CASCADE,
    extracted_from varchar(50) NOT NULL, -- 'tenant_message' or 'ai_response'
    weekly_amount decimal(10,2),
    duration_weeks integer,
    start_date date,
    validation_result jsonb,
    status varchar(50) DEFAULT 'detected',
    created_at timestamp with time zone DEFAULT now()
);
```

### API Specifications
**POST /orchestrate/payment-plan-detected Endpoint** (from `docs/architecture/rest-api-spec.md`):
- **Purpose**: Process detected payment plan from tenant or AI response
- **Request Body**:
  - conversation_id (UUID, required): Conversation identifier
  - tenant_id (string, required): Tenant identifier
  - message_content (string, required): Original message content
  - ai_response (string, optional): AI-generated response with payment plan
- **Response**: 200 OK for successful processing
- **Error Handling**: 400 for invalid payment plan data

### File Locations
Based on `docs/architecture/source-tree.md`:
- **Extraction Utility**: `app/utils/payment_plan_extraction.py` - Pattern matching logic
- **Service Layer**: `app/services/payment_plan_service.py` - Business logic and validation
- **API Layer**: `app/api/payment_plan.py` - REST endpoint implementation
- **Data Models**: `app/models/payment_plan.py` - PaymentPlanAttempt model
- **Schemas**: `app/schemas/payment_plan.py` - Request/response validation
- **Tests**:
  - `tests/test_utils/test_payment_plan_extraction.py`
  - `tests/test_services/test_payment_plan_service.py`
  - `tests/test_api/test_payment_plan.py`

### Technology Stack
**From `docs/architecture/tech-stack.md`**:
- **Language**: Python 3.11+ with type hints
- **Framework**: FastAPI 0.104+ for API endpoints
- **Database**: Supabase (PostgreSQL) for payment plan storage
- **Validation**: Pydantic models for request/response validation
- **Pattern Matching**: Python regex with custom extraction logic
- **Testing**: pytest 7.4+ with mocking for external dependencies

### Business Rules Validation
**Payment Plan Constraints** (from Epic Details):
- **Maximum Duration**: 12 weeks total
- **Minimum Weekly Payment**: $25 per week
- **Validation Requirements**:
  - Realistic payment amounts based on tenant context
  - Structured format detection (amount + duration)
  - Start date reasonableness validation
  - Auto-approval for clearly valid plans

### Integration Points
**AI Response Integration**:
- Parse AI responses for structured payment plan markers like "PAYMENT_PLAN: weekly=200, weeks=8"
- Extract payment plans from both tenant messages and AI-generated responses
- Coordinate with existing AI service workflow integration

**Workflow Integration**:
- Create payment plan attempts within existing workflow context
- Update workflow status based on payment plan validation results
- Use existing workflow step tracking for audit trails

### Technical Constraints
**From `docs/architecture/coding-standards.md`**:
- Use snake_case for files and functions: `payment_plan_extraction.py`, `extract_payment_plan()`
- Use PascalCase for classes: `PaymentPlanExtractor`, `PaymentPlanValidator`
- Always validate external inputs using Pydantic models
- Use structured logging with correlation IDs (no console.log)
- Database operations through service layer, never direct from API routes
- Follow existing error handling patterns with proper status codes
- Use async/await patterns for all database operations

### Testing
**From `docs/architecture/test-strategy-and-standards.md`**:
- **Framework**: pytest 7.4+ with pytest-asyncio
- **Coverage**: 80% line coverage for critical paths
- **Test Organization**: Mirror app/ structure in tests/test_*/
- **Mocking**: pytest-mock for external dependencies
- **Test Types**: Unit tests for extraction/validation logic, Integration tests for API endpoints
- **Pattern**: AAA (Arrange, Act, Assert) for all test cases

**Specific Testing Requirements**:
- Test extraction patterns with various payment plan formats
- Test validation business rules (min $25/week, max 12 weeks)
- Test API endpoint with valid and invalid payment plan data
- Mock external dependencies (database, AI service)
- Test integration with existing workflow tracking

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
<!-- To be populated by Dev Agent -->

### Debug Log References
<!-- To be populated by Dev Agent -->

### Completion Notes List
<!-- To be populated by Dev Agent -->

### File List
<!-- To be populated by Dev Agent -->

## QA Results
<!-- To be populated by QA Agent -->