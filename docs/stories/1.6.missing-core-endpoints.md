# Story 1.6: Missing Core Endpoints Implementation

## Status
Draft

## Story
**As a** developer,
**I want** to move the existing core endpoints from main.py to proper API routers and remove unnecessary duplicate endpoints,
**so that** the orchestrator service follows proper API structure, matches Kurt's specification, and eliminates maintenance overhead without breaking existing functionality.

## Acceptance Criteria
1. Move existing POST `/orchestrate/payment-plan-detected` endpoint to proper orchestration API router (already exists in payment_plan.py)
2. Move existing POST `/orchestrate/escalate` endpoint from main.py to proper API router with full workflow integration
3. Move existing POST `/orchestrate/retry/{workflow_id}` endpoint from main.py to proper API router with proper error handling
4. Ensure all endpoints follow established API patterns with proper validation, error handling, and structured logging
5. Remove duplicate/unnecessary endpoints that don't serve core workflow purposes
6. Comprehensive test coverage for all moved endpoints including error scenarios and integration testing

## Tasks / Subtasks
- [x] Task 1: Move escalation endpoint from main.py to proper API router (AC: 2, 4)
  - [x] Create POST /orchestrate/escalate endpoint in app/api/orchestration.py (or create orchestration_core.py)
  - [x] Move existing escalation logic from main.py to proper API router
  - [x] Ensure proper integration with EscalationService and workflow tracking
  - [x] Add structured logging with correlation IDs
  - [x] Remove the old endpoint from main.py
- [x] Task 2: Move retry endpoint from main.py to proper API router (AC: 3, 4)
  - [x] Create POST /orchestrate/retry/{workflow_id} endpoint in proper API router
  - [x] Move existing retry logic from main.py to proper API router
  - [x] Ensure proper error handling and validation
  - [x] Add structured logging with correlation IDs
  - [x] Remove the old endpoint from main.py
- [x] Task 3: Verify payment-plan-detected endpoint is correctly placed (AC: 1, 4)
  - [x] Confirm POST /orchestrate/payment-plan-detected exists in app/api/payment_plan.py
  - [x] Ensure it follows proper API patterns and validation
  - [x] Verify it integrates properly with workflow tracking
  - [x] Test the endpoint works as expected
- [x] Task 4: Remove unnecessary/duplicate endpoints (AC: 5) - **CAREFUL: Ensure no breaking changes**
  - [x] **CRITICAL:** Run full test suite before removing any endpoints to establish baseline
  - [x] Identify endpoints that don't serve core workflow purposes
  - [x] **IMPORTANT:** Check if any existing services/clients depend on endpoints before removal
  - [x] Remove duplicate health/metrics endpoints that overlap with existing ones
  - [x] **CRITICAL:** Remove endpoints one at a time and test after each removal
  - [x] Consolidate escalation endpoints to avoid confusion
  - [x] **CRITICAL:** Run full regression tests after all removals to ensure no functionality broken
  - [x] Keep only essential endpoints from Kurt's spec plus truly valuable additions
- [x] Task 5: Update main.py to include new API routers (AC: 1, 2, 3)
  - [x] Import and include the updated orchestration router
  - [x] Ensure all endpoints are properly registered
  - [x] Test that all endpoints are accessible
- [x] Task 6: Create comprehensive tests for moved endpoints (AC: 6)
  - [x] Create tests/test_api/test_orchestration.py for escalation and retry endpoints
  - [x] Test all moved endpoints with various scenarios
  - [x] Test error handling and validation
  - [x] Test integration with existing services

## Dev Notes

### Previous Story Insights
Stories 1.1-1.5 established the core orchestration service with SMS processing, AI response generation, approval workflows, and workflow status tracking. However, some core endpoints from Kurt's specification ended up in main.py instead of proper API routers, and there are duplicate endpoints that don't serve essential purposes.

### Current Endpoint Situation
**Already Properly Implemented:**
- `POST /orchestrate/payment-plan-detected` ✅ Exists in app/api/payment_plan.py

**Need to Move from main.py:**
- `POST /orchestrate/escalate` ❌ Currently in main.py - needs proper API router
- `POST /orchestrate/retry/{workflow_id}` ❌ Currently in main.py - needs proper API router

**To Remove/Cleanup:**
- Duplicate health endpoints that overlap with existing health.py
- Unnecessary escalation management endpoints beyond Kurt's spec
- Administrative overhead endpoints that don't serve core workflow purposes

**Goal:** Consolidate endpoints to match Kurt's 8 core endpoints plus truly valuable monitoring additions.

### Endpoint Cleanup Strategy
**Kurt's Core 8 Endpoints (KEEP):**
1. `POST /orchestrate/sms-received` ✅ Already implemented
2. `POST /orchestrate/approve-response` ✅ Already implemented
3. `POST /orchestrate/payment-plan-detected` ✅ Already in payment_plan.py
4. `POST /orchestrate/escalate` ❌ Move from main.py to proper router
5. `GET /orchestrate/workflow/{conversation_id}/status` ✅ Already implemented
6. `GET /health/dependencies` ✅ Already implemented
7. `POST /orchestrate/retry/{workflow_id}` ❌ Move from main.py to proper router
8. `GET /orchestrate/metrics` ✅ Already implemented

**Valuable Additions to KEEP:**
- `GET /health/detailed` - Useful for debugging
- `GET /orchestrate/metrics/performance` - Useful for monitoring
- `POST /escalation/trigger` - Useful for manual escalations

**Specific Endpoints to REMOVE:**

**From escalation.py (keep only POST /trigger):**
- ❌ `GET /escalation/status/{workflow_id}` - Not in Kurt's spec
- ❌ `GET /escalation/statistics` - Administrative overhead
- ❌ `POST /escalation/check-timeouts` - Internal operation, not external API
- ❌ `POST /escalation/register-timeout` - Administrative overhead
- ❌ `PUT /escalation/update-timeout/{workflow_id}` - Administrative overhead
- ❌ `DELETE /escalation/remove/{workflow_id}` - Administrative overhead
- ❌ `GET /escalation/health` - Duplicate of health endpoints

**From metrics.py (keep only GET /orchestrate/metrics):**
- ❌ `GET /orchestrate/metrics/prometheus` - Not needed for MVP
- ❌ `GET /orchestrate/metrics/performance` - Nice to have, not essential
- ❌ `GET /orchestrate/metrics/business` - Not needed for MVP
- ❌ `GET /orchestrate/metrics/health` - Duplicate health monitoring
- ❌ `GET /orchestrate/metrics/circuit-breakers` - Internal monitoring
- ❌ `GET /orchestrate/metrics/throughput` - Not needed for MVP
- ❌ `POST /orchestrate/metrics/clear-cache` - Administrative overhead
- ❌ `GET /orchestrate/metrics/summary` - Redundant with main metrics

**From health.py (keep core health endpoints):**
- ❌ `GET /health/dependencies/detailed` - Too verbose, basic one sufficient
- ❌ `POST /health/dependencies/reset` - Administrative operation
- ❌ `GET /health/degradation` - Internal monitoring

**Total to Remove: 15 endpoints**
**Keep: 11 core endpoints (8 from Kurt + 3 valuable additions)**

**Action Items:**
- Move 2 endpoints from main.py to proper API routers
- Remove 15 specific unnecessary/duplicate endpoints
- Keep the core 8 endpoints + 3 valuable additions
- Consolidate from 33+ endpoints to 11 total endpoints

### Integration with Existing Services
This story focuses on moving existing endpoints to proper API structure:
- **EscalationService**: Already integrated, just need to move endpoint
- **WorkflowService**: Already integrated, just need to move endpoint
- **Database Service**: Already integrated, just need to move endpoint
- **Existing schemas**: Use existing request/response models
- **Existing error handling**: Follow established patterns

### Error Handling and Validation
**Use Existing Patterns:**
- Follow existing error handling in payment_plan.py and other API routers
- Use existing custom exception classes and HTTP status codes
- Use existing correlation ID logging patterns
- Follow existing validation patterns with Pydantic models

### Project Structure Changes
**Files to Modify:**
- `app/main.py` - Remove escalation and retry endpoints
- `app/api/orchestration.py` - Add escalation and retry endpoints (or create orchestration_core.py)
- `tests/test_api/test_orchestration.py` - Add tests for moved endpoints

**Files to Remove/Consolidate:**
- Remove unnecessary endpoints from escalation.py, metrics.py (keep only essential ones)
- Consolidate duplicate functionality

### Technology Stack
- Use existing FastAPI router patterns
- Use existing Pydantic schemas and validation
- Follow existing async service integration patterns
- Use existing structured logging and correlation ID patterns

### Testing
**Test Requirements:**
- **CRITICAL:** Run full test suite BEFORE making any changes to establish baseline
- Use existing pytest patterns from other API tests
- Test moved endpoints work the same as before
- Test integration with existing services
- **CRITICAL:** Ensure no functionality is broken by moving/removing endpoints
- Run full regression test suite AFTER each endpoint removal
- **CRITICAL:** All tests must pass before marking story complete

### Safety Measures
**Pre-Change Checks:**
- Run `python -m pytest` to establish baseline test pass rate
- Document all existing endpoints and their purposes
- Check for any external dependencies on endpoints to be removed

**During Removal Process:**
- Remove endpoints ONE AT A TIME only
- Run full test suite after each removal
- If any test fails, restore the endpoint and investigate
- Never remove multiple endpoints at once

**Post-Change Validation:**
- All core functionality must work exactly as before
- No external service integrations should be broken
- All remaining endpoints must be accessible and functional
- Full regression test suite must pass (100% of existing tests)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Review Date:

### Reviewed By:

### Code Quality Assessment

### Refactoring Performed

### Compliance Check

### Improvements Checklist

### Security Review

### Performance Considerations

### Files Modified During Review

### Gate Status

### Recommended Status